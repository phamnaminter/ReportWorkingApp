name: Deploy app to AWS ECS

on:
  workflow_dispatch:
  push:
    branches:
      - develop

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      ecr_registry: ${{ steps.login-ecr.outputs.registry }}
      image: ${{ steps.push-image.outputs.image }}
      image_admin: ${{ steps.push-image.outputs.image_admin }}
    steps:

    - name: Set environment variables develop
      run: |
        echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
        echo "IMAGE_TAG_ADMIN=${GITHUB_SHA:7:7}" >> $GITHUB_ENV
        echo "ENV=dev" >> $GITHUB_ENV
        echo "ACCOUNT_ID=${{ secrets.ACCOUNT_ID }}" >> $GITHUB_ENV
        echo "ECR=dev-ecr" >> $GITHUB_ENV
        echo "AWS_REGION=ap-northeast-1" >> $GITHUB_ENV
        echo "AWS_ROLE_ARN=${{ secrets.AWS_ROLE_ARN }}" >> $GITHUB_ENV

    - uses: actions/checkout@v2

    - name: Configure AWS credentials from IAM
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ env.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        mask-aws-account-id: 'no'

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build images
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        echo "-e '${{ secrets.CDN_KEY_PAIR_DEV }}' >> .pem/pk-${{ secrets.CDN_KEY_PAIR_ID_DEV }}.pem"
        envsubst < Dockerfile > Dockerfile_change
        docker build -t $ECR_REGISTRY/$ECR:$IMAGE_TAG -f Dockerfile_change .
        echo "Build image successfully: #{$ECR_REGISTRY/$ECR:$IMAGE_TAG}"
    - name: Push images
      id: push-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        docker push $ECR_REGISTRY/$ECR:$IMAGE_TAG
        echo "::set-output name=image::$ECR_REGISTRY/$ECR:$IMAGE_TAG"
